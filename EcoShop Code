<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EcoShop – Sustainable Living Marketplace</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Poppins", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #f5f7f5;
        }

        .navbar-brand span {
            color: #28a745;
            font-weight: 700;
        }

        .hero {
            padding: 7rem 1rem 5rem;
            background: linear-gradient(135deg, #e8f5e9, #f1f8e9);
        }

        .hero-title {
            font-weight: 700;
            font-size: 2.4rem;
        }

        .hero-subtitle {
            font-size: 1.1rem;
            color: #555;
        }

        .section-title {
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .section-padding {
            padding: 4rem 0;
        }

        footer {
            background: #1b1f1b;
            color: #ccc;
            padding: 2rem 0;
            margin-top: 3rem;
        }

        .calculator-result {
            font-size: 1.1rem;
            font-weight: 600;
            color: #28a745;
        }

        .forum-thread {
            border-left: 4px solid #28a745;
            padding-left: 0.75rem;
        }

        .pointer {
            cursor: pointer;
        }

        .toast-container {
            position: fixed;
            top: 0.75rem;
            right: 0.75rem;
            z-index: 1080;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#hero">
            Eco<span>Shop</span>
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div id="mainNav" class="collapse navbar-collapse">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="#products">Products</a></li>
                <li class="nav-item"><a class="nav-link" href="#blog">Blog</a></li>
                <li class="nav-item"><a class="nav-link" href="#calculator">Calculator</a></li>
                <li class="nav-item"><a class="nav-link" href="#faq">FAQ</a></li>
                <li class="nav-item"><a class="nav-link" href="#downloads">Downloads</a></li>
                <li class="nav-item"><a class="nav-link" href="#forum">Forum</a></li>
                <li class="nav-item"><a class="nav-link" href="#analytics">Analytics</a></li>
                <li class="nav-item"><a class="nav-link" href="#about">About</a></li>
                <li class="nav-item"><a class="nav-link" href="#contact">Contact</a></li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                        Account
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item pointer" data-bs-toggle="modal" data-bs-target="#loginModal">Login</a></li>
                        <li><a class="dropdown-item pointer" data-bs-toggle="modal" data-bs-target="#signupModal">Sign Up</a></li>
                        <li><a class="dropdown-item pointer d-none" id="logoutBtn">Logout</a></li>
                    </ul>
                </li>

                <li class="nav-item">
                    <button class="btn btn-sm btn-success ms-lg-2" data-bs-toggle="modal" data-bs-target="#cartModal">
                        Cart <span id="cartCount" class="badge bg-light text-dark">0</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<!-- Hero -->
<header id="hero" class="hero">
    <div class="container">
        <div class="row align-items-center g-4">
            <div class="col-lg-6">
                <h1 class="hero-title mb-3">Sustainable Living Starts with Every Cart.</h1>
                <p class="hero-subtitle mb-4">
                    EcoShop connects you to reusable, organic and zero-waste essentials while
                    teaching practical ways to live greener.
                </p>
                <div class="d-flex flex-wrap gap-2">
                    <a href="#products" class="btn btn-success btn-lg">Shop Now</a>
                    <a href="#blog" class="btn btn-outline-success btn-lg">Learn to Live Greener</a>
                </div>
                <div class="mt-4 small text-muted">
                    Outcomes: engagement, education, community and eco-friendly sales.
                </div>
            </div>

            <div class="col-lg-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <p class="fw-semibold mb-2">Sustainability snapshot</p>
                        <p class="mb-1">
                            Total CO₂ saved this month:
                            <span id="snapshotCo2" class="fw-bold text-success">0 kg</span>
                        </p>
                        <p class="mb-1">
                            Active community members:
                            <span id="snapshotUsers" class="fw-bold text-success">0</span>
                        </p>
                        <p class="mb-0">
                            Top product: <span id="snapshotTopProduct" class="fw-semibold">Loading…</span>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Products -->
<section id="products" class="section-padding">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="section-title mb-0">Eco-Friendly Product Gallery</h2>
            <span class="badge bg-success">Zero-Waste • Organic • Reusable</span>
        </div>

        <form class="row g-2 mb-4" id="productSearchForm">
            <div class="col-md-4">
                <input type="text" class="form-control" id="searchQuery" placeholder="Search products (e.g. bamboo, bottle)">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="categoryFilter">
                    <option value="">All Categories</option>
                    <option value="reusable">Reusable</option>
                    <option value="organic">Organic</option>
                    <option value="zero-waste">Zero Waste</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="sortBy">
                    <option value="">Sort By</option>
                    <option value="price_asc">Price: low to high</option>
                    <option value="price_desc">Price: high to low</option>
                </select>
            </div>
            <div class="col-md-2 d-grid">
                <button class="btn btn-success" type="submit">Search</button>
            </div>
        </form>

        <div id="productGrid" class="row g-4"></div>
    </div>
</section>

<!-- Blog -->
<section id="blog" class="section-padding bg-white">
    <div class="container">
        <h2 class="section-title">Sustainable Living Blog</h2>
        <p class="mb-4">Tips, guides and real stories to help you build greener habits.</p>

        <div class="row g-4" id="blogList">
            <div class="col-md-4">
                <article class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Zero-Waste Kitchen in 7 Days</h5>
                        <p class="card-text small text-muted">
                            Learn how to swap plastic wraps, paper towels, and more with simple reusable alternatives.
                        </p>
                        <a href="#" class="btn btn-outline-success btn-sm">Read More</a>
                    </div>
                </article>
            </div>

            <div class="col-md-4">
                <article class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Composting for Small Spaces</h5>
                        <p class="card-text small text-muted">
                            Apartment-friendly composting ideas that reduce food waste and enrich soil.
                        </p>
                        <a href="#" class="btn btn-outline-success btn-sm">Read More</a>
                    </div>
                </article>
            </div>

            <div class="col-md-4">
                <article class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">Building an Eco Capsule Wardrobe</h5>
                        <p class="card-text small text-muted">
                            Buy less, choose well, and take care of the clothes you already own.
                        </p>
                        <a href="#" class="btn btn-outline-success btn-sm">Read More</a>
                    </div>
                </article>
            </div>
        </div>
    </div>
</section>

<!-- Testimonials -->
<section id="testimonials" class="section-padding">
    <div class="container">
        <h2 class="section-title">What Our Community Says</h2>
        <div class="row g-4">
            <div class="col-md-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <p class="mb-1">“EcoShop made it so easy to switch to reusable essentials.”</p>
                        <small class="text-muted">— Alex, teacher</small>
                        <div class="mt-2 text-warning">★★★★★</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <p class="mb-1">“The sustainability calculator helped my family see our impact.”</p>
                        <small class="text-muted">— Priya, parent</small>
                        <div class="mt-2 text-warning">★★★★☆</div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body">
                        <p class="mb-1">“I love reading the eco-living blog while I sip my fair-trade coffee.”</p>
                        <small class="text-muted">— Diego, student</small>
                        <div class="mt-2 text-warning">★★★★★</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- FAQ -->
<section id="faq" class="section-padding bg-white">
    <div class="container">
        <h2 class="section-title">Frequently Asked Questions</h2>
        <div class="accordion" id="faqAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="faqHeading1">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapse1">
                        How does EcoShop choose products?
                    </button>
                </h2>
                <div id="faqCollapse1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        We prioritize reusable, low-waste, and ethically sourced items. Each product goes through a sustainability review by our team.
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="faqHeading2">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapse2">
                        How long does shipping take?
                    </button>
                </h2>
                <div id="faqCollapse2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        Most orders arrive in 5–7 business days using carbon-offset shipping.
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="faqHeading3">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faqCollapse3">
                        Can I return or exchange items?
                    </button>
                </h2>
                <div id="faqCollapse3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        Yes, we offer 30-day returns on most items. See our returns policy for details.
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Calculator -->
<section id="calculator" class="section-padding">
    <div class="container">
        <h2 class="section-title">Sustainability Calculator</h2>
        <p class="mb-4">Estimate your yearly CO₂ savings by switching to eco-friendly choices.</p>

        <form id="calculatorForm" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Reusable bottles used per week</label>
                <input type="number" min="0" value="3" class="form-control" id="bottlesPerWeek">
            </div>
            <div class="col-md-4">
                <label class="form-label">Reusable bags used per week</label>
                <input type="number" min="0" value="4" class="form-control" id="bagsPerWeek">
            </div>
            <div class="col-md-4">
                <label class="form-label">Km of car trips replaced by biking per week</label>
                <input type="number" min="0" value="5" class="form-control" id="bikeKmPerWeek">
            </div>
            <div class="col-12 d-grid d-md-block">
                <button class="btn btn-success mt-2" type="submit">Calculate Savings</button>
            </div>
        </form>

        <div class="mt-3">
            <span class="calculator-result" id="calculatorResult">Your yearly CO₂ savings will appear here.</span>
        </div>
    </div>
</section>

<!-- Newsletter + Downloads -->
<section id="downloads" class="section-padding bg-white">
    <div class="container">
        <div class="row g-5 align-items-start">
            <div class="col-md-6">
                <h2 class="section-title">Newsletter Signup</h2>
                <p>Get eco-tips, product drops and sustainability stories in your inbox.</p>

                <form id="newsletterForm" class="row g-2">
                    <div class="col-12">
                        <input type="email" id="newsletterEmail" class="form-control" placeholder="you@example.com" required>
                    </div>
                    <div class="col-12 d-grid d-md-block">
                        <button type="submit" class="btn btn-success mt-2">Subscribe</button>
                    </div>
                </form>
            </div>

            <div class="col-md-6">
                <h2 class="section-title">Download Center</h2>
                <p class="mb-3">Free guides to kick-start your eco-living journey.</p>

                <ul class="list-group" id="downloadList">
                    <li class="list-group-item">
                        <div class="fw-semibold">Sustainable Living 101</div>
                        <div class="small text-muted mb-2">Beginner-friendly guide to eco-friendly habits</div>
                        <button class="btn btn-outline-success btn-sm" type="button">Download PDF</button>
                    </li>
                    <li class="list-group-item">
                        <div class="fw-semibold">Plastic-Free Starter Guide</div>
                        <div class="small text-muted mb-2">Simple swaps to reduce single-use plastics</div>
                        <button class="btn btn-outline-success btn-sm" type="button">Download PDF</button>
                    </li>
                    <li class="list-group-item">
                        <div class="fw-semibold">Eco-Friendly Home Checklist</div>
                        <div class="small text-muted mb-2">Room by room sustainability checklist</div>
                        <button class="btn btn-outline-success btn-sm" type="button">Download PDF</button>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</section>

<!-- Forum -->
<section id="forum" class="section-padding">
    <div class="container">
        <h2 class="section-title">Community Forum</h2>
        <p class="mb-3">Ask questions, share tips, and celebrate small eco-wins with others.</p>

        <div class="mb-4">
            <form id="forumForm" class="row g-2">
                <div class="col-md-9">
                    <input type="text" id="forumTopic" class="form-control" placeholder="Start a new discussion (e.g. Best zero-waste swaps)">
                </div>
                <div class="col-md-3 d-grid">
                    <button type="submit" class="btn btn-success">Post Topic</button>
                </div>
            </form>
        </div>

        <div id="forumThreads" class="list-group">
            <div class="list-group-item">
                <div class="forum-thread mb-1">
                    <strong>Zero-Waste Bathroom Ideas</strong>
                </div>
                <small class="text-muted">Posted by <span class="text-success">eco_ally</span> • 12 replies</small>
                <p class="small mb-0">
                    What swaps have made the biggest difference for you? I started with shampoo bars and safety razors…
                </p>
            </div>
        </div>
    </div>
</section>

<!-- Analytics -->
<section id="analytics" class="section-padding bg-white">
    <div class="container">
        <h2 class="section-title">Analytics Dashboard</h2>
        <p class="mb-3">Track visits, top products, and user engagement.</p>

        <div class="row g-4">
            <div class="col-md-8">
                <canvas id="trafficChart" height="140"></canvas>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <h6 class="fw-semibold mb-2">Today’s Snapshot</h6>
                        <p class="mb-1 small">Visits: <span id="statVisits" class="fw-bold">0</span></p>
                        <p class="mb-1 small">Products viewed: <span id="statProducts" class="fw-bold">0</span></p>
                        <p class="mb-0 small">Active users: <span id="statActiveUsers" class="fw-bold">0</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- About -->
<section id="about" class="section-padding">
    <div class="container">
        <h2 class="section-title">About EcoShop</h2>
        <div class="row g-4 align-items-center">
            <div class="col-md-6">
                <p>
                    EcoShop was created to make sustainable living simple, affordable, and inspiring.
                    We curate products that reduce waste and support ethical makers while educating visitors through blogs,
                    tools, and community features.
                </p>
                <p>
                    Our mission is to help you take small, consistent steps that protect the planet while improving everyday life.
                </p>
            </div>

            <div class="col-md-6">
                <div class="row g-3">
                    <div class="col-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <p class="fw-semibold mb-1">Team</p>
                                <p class="small mb-0">Designers & developers building this platform together.</p>
                            </div>
                        </div>
                    </div>

                    <div class="col-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body text-center">
                                <p class="fw-semibold mb-1">Values</p>
                                <p class="small mb-0">Transparency, sustainability, inclusion, and continuous learning.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Contact -->
<section id="contact" class="section-padding bg-white">
    <div class="container">
        <h2 class="section-title">Contact Us</h2>
        <p class="mb-3">Questions, feedback, or partnership ideas? Send us a message.</p>

        <form id="contactForm" class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Name</label>
                <input type="text" id="contactName" class="form-control" required>
            </div>
            <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" id="contactEmail" class="form-control" required>
            </div>
            <div class="col-12">
                <label class="form-label">Message</label>
                <textarea id="contactMessage" rows="4" class="form-control" required></textarea>
            </div>
            <div class="col-12 d-grid d-md-block">
                <button class="btn btn-success" type="submit">Send Message</button>
            </div>
        </form>
    </div>
</section>

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row align-items-center g-3">
            <div class="col-md-6">
                <p class="mb-0 small">
                    &copy; <span id="year"></span> EcoShop – Sustainable Living Marketplace.
                </p>
            </div>
            <div class="col-md-6 text-md-end small">
                Product discovery, communities, and sustainability tools.
            </div>
        </div>
    </div>
</footer>

<!-- Login Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="loginForm">
            <div class="modal-header">
                <h5 class="modal-title">Log in to EcoShop</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Email or Username</label>
                    <input type="text" class="form-control" id="loginIdentifier" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Log In</button>
            </div>
        </form>
    </div>
</div>

<!-- Signup Modal -->
<div class="modal fade" id="signupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" id="signupForm">
            <div class="modal-header">
                <h5 class="modal-title">Create an EcoShop Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Name</label>
                    <input type="text" id="signupName" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Email</label>
                    <input type="email" id="signupEmail" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Password</label>
                    <input type="password" id="signupPassword" class="form-control" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-success">Sign Up</button>
            </div>
        </form>
    </div>
</div>

<!-- Cart Modal -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Your Cart</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="cartItems"></div>
                <hr>
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Total:</strong>
                        <span id="cartTotal" class="fw-bold">$0.00</span>
                    </div>
                    <button class="btn btn-success" id="checkoutBtn">Proceed to Checkout</button>
                </div>

                <form id="checkoutForm" class="mt-3 d-none">
                    <h6 class="fw-semibold mb-2">Checkout</h6>
                    <div class="row g-2">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="checkoutName" placeholder="Full name" required>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="checkoutAddress" placeholder="Shipping address" required>
                        </div>
                        <div class="col-12">
                            <input type="text" class="form-control mb-2" id="checkoutCity" placeholder="City, Country" required>
                        </div>
                    </div>
                    <button class="btn btn-success mt-2" type="submit">Confirm Purchase</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script>
    const API_BASE_URL = "http://localhost:5000/api";
    let authToken = null;
    let cart = [];

    const demoProducts = [
        { id: 1, name: "Bamboo Toothbrush", price: 4.99, category: "zero-waste" },
        { id: 2, name: "Stainless Steel Water Bottle", price: 19.99, category: "reusable" },
        { id: 3, name: "Organic Cotton Tote Bag", price: 12.5, category: "organic" },
        { id: 4, name: "Glass Food Storage Set", price: 29.99, category: "reusable" }
    ];

    function showToast(message, isSuccess = true) {
        const id = "toast" + Date.now();
        const toastHtml = `
          <div id="${id}" class="toast align-items-center text-bg-${isSuccess ? "success" : "danger"} border-0 mb-2" role="alert">
            <div class="d-flex">
              <div class="toast-body">${message}</div>
              <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
          </div>`;
        const container = document.getElementById("toastContainer");
        container.insertAdjacentHTML("beforeend", toastHtml);
        const toastEl = document.getElementById(id);
        const toast = new bootstrap.Toast(toastEl, {delay: 3000});
        toast.show();
    }

    function formatPrice(value) {
        return "$" + value.toFixed(2);
    }

    async function loginUser(event) {
        event.preventDefault();
        const identifier = document.getElementById("loginIdentifier").value.trim();
        const password = document.getElementById("loginPassword").value;

        try {
            const res = await fetch(API_BASE_URL + "/auth/login", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({identifier, password})
            });

            if (!res.ok) throw new Error("Login failed");
            const data = await res.json();
            authToken = data.token;
            localStorage.setItem("ecoToken", authToken);
            localStorage.setItem("ecoUserRole", data.role || "user");
            document.getElementById("logoutBtn").classList.remove("d-none");
            showToast("Logged in successfully.");
            bootstrap.Modal.getInstance(document.getElementById("loginModal")).hide();
        } catch (err) {
            console.error(err);
            showToast("Unable to log in. Check credentials or backend.", false);
        }
    }

    async function signupUser(event) {
        event.preventDefault();
        const name = document.getElementById("signupName").value.trim();
        const email = document.getElementById("signupEmail").value.trim();
        const password = document.getElementById("signupPassword").value;

        try {
            const res = await fetch(API_BASE_URL + "/auth/register", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({name, email, password})
            });
            if (!res.ok) throw new Error("Signup failed");
            showToast("Account created! You can now log in.");
            bootstrap.Modal.getInstance(document.getElementById("signupModal")).hide();
        } catch (err) {
            console.error(err);
            showToast("Unable to sign up. Check backend validation.", false);
        }
    }

    function logoutUser() {
        authToken = null;
        localStorage.removeItem("ecoToken");
        localStorage.removeItem("ecoUserRole");
        document.getElementById("logoutBtn").classList.add("d-none");
        showToast("Logged out.");
    }

    async function loadProducts(options = {}) {
        const params = new URLSearchParams();
        if (options.search) params.append("q", options.search);
        if (options.category) params.append("category", options.category);
        if (options.sortBy) params.append("sort", options.sortBy);

        let products;
        try {
            const res = await fetch(API_BASE_URL + "/products?" + params.toString());
            if (!res.ok) throw new Error("Backend unavailable");
            products = await res.json();
        } catch (err) {
            console.warn("Falling back to demo products:", err.message);
            products = demoProducts;
        }
        renderProducts(products);
    }

    function renderProducts(products) {
        const grid = document.getElementById("productGrid");
        grid.innerHTML = "";
        if (!products.length) {
            grid.innerHTML = "<p>No products found.</p>";
            return;
        }
        for (const product of products) {
            const col = document.createElement("div");
            col.className = "col-md-3";
            col.innerHTML = `
              <div class="card h-100 shadow-sm">
                  <div class="card-body d-flex flex-column">
                      <h6 class="card-title">${product.name}</h6>
                      <p class="small text-muted mb-1">${product.category || ""}</p>
                      <p class="fw-bold mb-2">${formatPrice(product.price)}</p>
                      <button class="btn btn-sm btn-success mt-auto" data-product-id="${product.id}">
                          Add to Cart
                      </button>
                  </div>
              </div>`;
            grid.appendChild(col);
        }

        grid.querySelectorAll("button[data-product-id]").forEach(btn => {
            btn.addEventListener("click", () => {
                const id = Number(btn.getAttribute("data-product-id"));
                const product = products.find(p => p.id === id);
                addToCart(product);
            });
        });
    }

    function handleProductSearch(event) {
        event.preventDefault();
        const search = document.getElementById("searchQuery").value.trim();
        const category = document.getElementById("categoryFilter").value;
        const sortBy = document.getElementById("sortBy").value;
        loadProducts({search, category, sortBy});
    }

    function addToCart(product) {
        if (!product) return;
        const existing = cart.find(item => item.id === product.id);
        if (existing) existing.qty += 1;
        else cart.push({...product, qty: 1});
        updateCartUI();
        showToast("Added to cart: " + product.name);
    }

    function updateCartUI() {
        const cartItemsDiv = document.getElementById("cartItems");
        const cartCountSpan = document.getElementById("cartCount");
        const cartTotalSpan = document.getElementById("cartTotal");

        cartCountSpan.textContent = cart.reduce((sum, item) => sum + item.qty, 0);

        if (!cart.length) {
            cartItemsDiv.innerHTML = "<p class='mb-0'>Your cart is empty.</p>";
            cartTotalSpan.textContent = "$0.00";
            return;
        }

        let total = 0;
        cartItemsDiv.innerHTML = "";
        cart.forEach(item => {
            total += item.price * item.qty;
            const row = document.createElement("div");
            row.className = "d-flex justify-content-between align-items-center mb-2";
            row.innerHTML = `
              <div>
                <strong>${item.name}</strong>
                <span class="small text-muted">x${item.qty}</span>
              </div>
              <div>
                <span class="small pointer text-danger me-2" data-remove-id="${item.id}">Remove</span>
                <span>${formatPrice(item.price * item.qty)}</span>
              </div>`;
            cartItemsDiv.appendChild(row);
        });
        cartTotalSpan.textContent = formatPrice(total);

        cartItemsDiv.querySelectorAll("[data-remove-id]").forEach(span => {
            span.addEventListener("click", () => {
                const id = Number(span.getAttribute("data-remove-id"));
                cart = cart.filter(item => item.id !== id);
                updateCartUI();
            });
        });
    }

    function toggleCheckoutForm() {
        const form = document.getElementById("checkoutForm");
        form.classList.toggle("d-none");
    }

    async function submitCheckout(event) {
        event.preventDefault();
        if (!cart.length) {
            showToast("Your cart is empty.", false);
            return;
        }

        const body = {
            items: cart,
            name: document.getElementById("checkoutName").value.trim(),
            address: document.getElementById("checkoutAddress").value.trim(),
            city: document.getElementById("checkoutCity").value.trim()
        };

        try {
            const res = await fetch(API_BASE_URL + "/orders", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    ...(authToken ? {Authorization: "Bearer " + authToken} : {})
                },
                body: JSON.stringify(body)
            });
            if (!res.ok) throw new Error("Order failed");
            showToast("Order placed successfully!");
            cart = [];
            updateCartUI();
            document.getElementById("checkoutForm").reset();
        } catch (err) {
            console.error(err);
            showToast("Checkout failed.", false);
        }
    }

    function handleCalculator(event) {
        event.preventDefault();
        const bottles = Number(document.getElementById("bottlesPerWeek").value) || 0;
        const bags = Number(document.getElementById("bagsPerWeek").value) || 0;
        const bikeKm = Number(document.getElementById("bikeKmPerWeek").value) || 0;

        const bottleKgPerYear = bottles * 0.08 * 52;
        const bagKgPerYear = bags * 0.02 * 52;
        const bikeKgPerYear = bikeKm * 0.21 * 52;

        const total = bottleKgPerYear + bagKgPerYear + bikeKgPerYear;

        document.getElementById("calculatorResult").textContent =
            "Estimated yearly CO₂ savings: " + total.toFixed(1) + " kg";
    }

    async function handleNewsletter(event) {
        event.preventDefault();
        const email = document.getElementById("newsletterEmail").value.trim();
        if (!email) return;

        try {
            const res = await fetch(API_BASE_URL + "/newsletter", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({email})
            });
            if (!res.ok) throw new Error("Newsletter failed");
            showToast("Thanks for subscribing!");
            event.target.reset();
        } catch (err) {
            console.error(err);
            showToast("Unable to subscribe.", false);
        }
    }

    async function handleContact(event) {
        event.preventDefault();
        const payload = {
            name: document.getElementById("contactName").value.trim(),
            email: document.getElementById("contactEmail").value.trim(),
            message: document.getElementById("contactMessage").value.trim()
        };

        try {
            const res = await fetch(API_BASE_URL + "/contact", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(payload)
            });
            if (!res.ok) throw new Error("Contact failed");
            showToast("Message sent! Thank you for reaching out.");
            event.target.reset();
        } catch (err) {
            console.error(err);
            showToast("Unable to send message", false);
        }
    }

    async function handleForumPost(event) {
        event.preventDefault();
        const topic = document.getElementById("forumTopic").value.trim();
        if (!topic) return;

        try {
            const res = await fetch(API_BASE_URL + "/forum/threads", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    ...(authToken ? {Authorization: "Bearer " + authToken} : {})
                },
                body: JSON.stringify({title: topic})
            });
            if (!res.ok) throw new Error("Forum post failed");
            showToast("Thread posted!");
        } catch (err) {
            console.error(err);
            showToast("Unable to post topic.", false);
        }

        const list = document.getElementById("forumThreads");
        const item = document.createElement("div");
        item.className = "list-group-item";
        item.innerHTML = `
          <div class="forum-thread mb-1">
            <strong>${topic}</strong>
          </div>
          <small class="text-muted">Posted just now • 0 replies</small>`;
        list.prepend(item);
        document.getElementById("forumTopic").value = "";
    }

    let trafficChart = null;

    async function loadAnalytics() {
        let data;
        try {
            const res = await fetch(API_BASE_URL + "/analytics/overview");
            if (!res.ok) throw new Error("Analytics backend unavailable");
            data = await res.json();
        } catch (err) {
            console.warn("Falling back to demo analytics:", err.message);
            data = {
                labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                visits: [120, 160, 210, 190, 240, 180, 200],
                productsViewed: 830,
                activeUsers: 54,
                co2Saved: 1280,
                topProduct: "Stainless Steel Water Bottle"
            };
        }

        document.getElementById("snapshotCo2").textContent = data.co2Saved + " kg";
        document.getElementById("snapshotUsers").textContent = data.activeUsers;
        document.getElementById("snapshotTopProduct").textContent = data.topProduct;
        document.getElementById("statVisits").textContent = data.visits.reduce((s, v) => s + v, 0);
        document.getElementById("statProducts").textContent = data.productsViewed;
        document.getElementById("statActiveUsers").textContent = data.activeUsers;

        const ctx = document.getElementById("trafficChart");
        if (trafficChart) trafficChart.destroy();
        trafficChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: data.labels,
                datasets: [{
                    label: "Visits",
                    data: data.visits,
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {display: false}
                },
                scales: {
                    y: {beginAtZero: true}
                }
            }
        });
    }

    function initLiveNotifications() {
        try {
            const source = new EventSource(API_BASE_URL + "/notifications/stream");
            source.onmessage = (event) => {
                const payload = JSON.parse(event.data);
                showToast("New notification: " + payload.message);
            };
            source.onerror = () => {
                console.warn("Live notifications stream not available.");
                source.close();
            };
        } catch (err) {
            console.warn("SSE not supported.");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("year").textContent = new Date().getFullYear();

        const savedToken = localStorage.getItem("ecoToken");
        if (savedToken) {
            authToken = savedToken;
            document.getElementById("logoutBtn").classList.remove("d-none");
        }

        document.getElementById("loginForm").addEventListener("submit", loginUser);
        document.getElementById("signupForm").addEventListener("submit", signupUser);
        document.getElementById("logoutBtn").addEventListener("click", logoutUser);

        document.getElementById("productSearchForm").addEventListener("submit", handleProductSearch);

        document.getElementById("checkoutBtn").addEventListener("click", toggleCheckoutForm);
        document.getElementById("checkoutForm").addEventListener("submit", submitCheckout);

        document.getElementById("calculatorForm").addEventListener("submit", handleCalculator);

        document.getElementById("newsletterForm").addEventListener("submit", handleNewsletter);

        document.getElementById("contactForm").addEventListener("submit", handleContact);

        document.getElementById("forumForm").addEventListener("submit", handleForumPost);

        loadProducts();
        loadAnalytics();
        initLiveNotifications();
    });
</script>
</body>
</html>
